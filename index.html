<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fruit Game</title>
    <link rel="icon" href="apple.png">
    <link rel="apple-touch-icon" href="apple.png">
    <link rel="apple-touch-icon-precomposed" href="apple.png">
    <meta name="description" content="フルーツをタップしよう！子供向けゲーム">
    <meta name="keywords" content="game, ゲーム, フルーツゲーム、知育、子供向けゲーム">
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
    <script>
        const config = {
            type: Phaser.AUTO,
            width: window.innerWidth,
            height: window.innerHeight,
            scene: {
                preload: preload,
                create: create,
                update: update
            },
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: false
                }
            }
        };

        const game = new Phaser.Game(config);

        let fruits;
        let isFirst = true;
        let currentFruit = 'apple';
        const fruitTypes = ['apple', 'grape', 'banana', 'melon', 'orange'];

        function preload() {
            this.load.image('apple', 'apple.png');
            this.load.image('grape', 'grape.png');
            this.load.image('banana', 'banana.png');
            this.load.image('melon', 'melon.png');
            this.load.image('orange', 'orange.png');
            this.load.audio('pop', 'pecho.mp3');
            this.load.audio('appear', 'poincho.mp3');
        }

        function create() {
            fruits = this.physics.add.group();
            this.input.on('pointerdown', handleTap, this);

            this.popSound = this.sound.add('pop');
            // this.appearSound = this.sound.add('appear');

            // 最初の果物を生成
            generateFruits.call(this, currentFruit);

            this.appearSound = this.sound.add('appear');
        }

        function update() {
            // 何もしない
        }

        function handleTap(pointer) {
            const children = fruits.getChildren();
            for (let i = children.length - 1; i >= 0; i--) {
                const fruit = children[i];
                if (Phaser.Geom.Rectangle.Contains(fruit.getBounds(), pointer.x, pointer.y)) {
                    this.tweens.add({
                        targets: fruit,
                        scaleX: 0,
                        scaleY: 0,
                        duration: 200,
                        ease: 'Power2',
                        onComplete: () => {
                            fruit.destroy();
                            this.popSound.play();
                            if (fruits.countActive(true) === 0) {
                                const nextIndex = (fruitTypes.indexOf(currentFruit) + 1) % fruitTypes.length;
                                currentFruit = fruitTypes[nextIndex];
                                generateFruits.call(this, currentFruit);
                            }
                        }
                    });
                    break;
                }
            }
        }

        function generateFruits(type) {
            fruits.clear(true, true);

            // 果物ごとの背景色を設定
            switch (type) {
                case 'apple':
                    this.cameras.main.setBackgroundColor('#ffbcbc');
                    document.body.style.backgroundColor = '#ffbcbc';
                    break;
                case 'grape':
                    this.cameras.main.setBackgroundColor('#c8ffd8');
                    document.body.style.backgroundColor = '#c8ffd8';
                    break;
                case 'banana':
                    this.cameras.main.setBackgroundColor('#fff4b3');
                    document.body.style.backgroundColor = '#fff4b3';
                    break;
                case 'melon':
                    this.cameras.main.setBackgroundColor('#ffd1dc');
                    document.body.style.backgroundColor = '#ffd1dc';
                    break;
                case 'orange':
                    this.cameras.main.setBackgroundColor('#ffe6b3');
                    document.body.style.backgroundColor = '#ffe6b3';
                    break;
                default:
                    this.cameras.main.setBackgroundColor('#ffbcbc');
                    document.body.style.backgroundColor = '#ffbcbc';
                    break;
            }

            // 果物を生成するループ
            const fruitSpeedX = 0.2;
            const fruitSpeedY = 0.2;

            for (let i = 0; i < 5; i++) {
                let x = Phaser.Math.Between(100, game.config.width - 100);
                let y = Phaser.Math.Between(100, game.config.height - 100);

                // 果物が画面端に生成されないようにする
                if (x < 100) {
                    x += 100;
                } else if (x > game.config.width - 100) {
                    x -= 100;
                }
                if (y < 100) {
                    y += 100;
                } else if (y > game.config.height - 100) {
                    y -= 100;
                }

                const fruit = fruits.create(x, y, type).setInteractive();

                // 果物のサイズを画面の面積の10分の1に設定
                const screenArea = game.config.width * game.config.height;
                const fruitArea = screenArea / 8;
                const fruitWidth = Math.sqrt(fruitArea);
                const fruitHeight = fruitWidth;
                
                fruit.setScale(fruitWidth / fruit.width, fruitHeight / fruit.height);
                fruit.setScale(0);

                // 果物のアニメーションを設定
                this.tweens.add({
                    targets: fruit,
                    scaleX: fruitWidth / fruit.width,
                    scaleY: fruitHeight / fruit.height,
                    duration: 500,
                    ease: 'Bounce.easeOut'
                });

                this.tweens.add({
                    targets: fruit,
                    duration: Phaser.Math.Between(4000, 6000),
                    x: x + Phaser.Math.Between(-100, 100),
                    y: y + Phaser.Math.Between(-100, 100),
                    yoyo: true,
                    repeat: -1,
                    ease: 'Sine.easeInOut',
                });

                fruit.speedX = fruitSpeedX;
                fruit.speedY = fruitSpeedY;
            }

            if(isFirst) {
                isFirst = false;
                return;
            }

            this.appearSound.play();            
        }

        window.onresize = function() {
            game.scale.resize(window.innerWidth, window.innerHeight);
        };
    </script>
</body>
</html>
